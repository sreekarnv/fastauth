name: License Year Updater

on:
  schedule:
    - cron: "0 0 1 1 *"  # Run January 1st each year
  workflow_dispatch:   # Allow manual trigger

jobs:
  update-license:
    name: Update License Year
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Update License Year
        id: update
        run: |
          CURRENT_YEAR=$(date +%Y)

          # Expose current year as an output for later steps
          echo "year=${CURRENT_YEAR}" >> $GITHUB_OUTPUT

          if grep -q "Copyright (c) [0-9]\{4\}" LICENSE; then
            # Already has a range ending in current year (e.g., 2025-2026)
            if grep -q "Copyright (c) [0-9]\{4\}-${CURRENT_YEAR}" LICENSE; then
              echo "License already up to date"
              echo "updated=false" >> $GITHUB_OUTPUT

            # Already has current year as a single year
            elif grep -q "Copyright (c) ${CURRENT_YEAR}" LICENSE; then
              echo "License already has current year"
              echo "updated=false" >> $GITHUB_OUTPUT

            else
              # Convert single year or existing range into startYear-CURRENT_YEAR
              sed -i -E "s/Copyright \(c\) ([0-9]{4})(-[0-9]{4})?/Copyright (c) \1-${CURRENT_YEAR}/" LICENSE
              echo "License updated to include ${CURRENT_YEAR}"
              echo "updated=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "No copyright line found"
            echo "updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.update.outputs.updated == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update license year to ${{ steps.update.outputs.year }}"
          title: ":page_facing_up: chore: update license year"
          body: |
            Automated license year update.

            Updates the copyright year in LICENSE file.
          branch: chore/license-year-update
          delete-branch: true
